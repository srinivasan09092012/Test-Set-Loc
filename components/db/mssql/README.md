# Microsoft SQL Server Database Platform

Back to [Project](../../../README.md) | [Components](../../README.md) | [Databases](../README.md)

---

Use this section of the repository to organize database components that make up the application domain. Feel free to reorganize the folder structure to whatever makes sense for the project.

## Intro

This directory should contain the scripts to support all Microsoft SQL Server databases associated with the product module.  There should be a separate high level directory associated with **each** database.

### Project Level Databases

- [AdventureWorks](AdventureWorks/README.md)

## Folder Structure

Each database should have the following basic structure, where certain sub-folders will be optional based upon the objects defined in the given database.

    |db
        |mssql
          |{database-name}
            |_Changes
              |_archive
            |Data
            |Database
            |Role
            |StoredProcedure
            |Table
            |User
            |UserDefinedDataType
            |UserDefinedFunction
            |View

Organizing database scripts in a consistent, prescribed structures defined above will allow us to:

- create repeatable, consistent processes and practices
- that can lead to predictable results
- which will ultimately allow us to automate
  - continuous integration and deployment into the product integration testing environments, and
  - creation of database packaging artifacts for feature, sprint, hotfix, and/or release deliverables.

Bulk of the database scripts will be automatically generated using a [PowerShell](https://docs.microsoft.com/en-us/powershell/) script which will make use of [python](https://www.python.org/) based command line interface for the [SQL Server Management Studio (SSMS)](https://docs.microsoft.com/en-us/sql/ssms/sql-server-management-studio-ssms?view=sql-server-ver15) feature for [Generating Scripts](https://docs.microsoft.com/en-us/sql/ssms/scripting/generate-scripts-sql-server-management-studio?view=sql-server-ver15) called [mssql-scripter](https://github.com/Microsoft/mssql-scripter).

## Rules for DB changes

The following practices and processes will need to be followed for database changes:

1. **ALL** database changes associated with feature development **MUST** be scripted.
2. Scripted database changes **MUST** be included in the feature branch merge into its **parent branch** (e.g. `main`, `r23`, `r24`, etc.) via **PULL REQUEST**.
   1. All DB script changes must be reviewed and approved by a member in the `db-reviewers` team
   2. Each repo should enforce the `db-reviewers` approval via [CODEOWNERS](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners#codeowners-syntax) approach as described in GitHub docs
3. Database changes identified in the `components\db\mssql` sub-directories will be applied in the following order. The files/scripts to include will be automatically identified based upon the **approval** event associated with the **parent branch** PULL REQUEST (using [GitHub REST API](http://docs.github.com/en/rest/guides/getting-started-with-the-rest-api) and its associated command line interface).
   1. _Changes
   2. StoredProcedure
   3. UserDefinedFunction
   4. View
4. Database changes in the following sub-directories are for **INFORMATIONAL PURPOSES** only. The contents in these directories will be automatically generated by the Continuous Integration (CI) process and/or End of Sprint (EOS) and/or End of Release (EOR) processes.
   1. Data
   2. Database
   3. Role
   4. Table
   5. User
   6. UserDefinedDataType
5. Database changes for stored procedure, user-defined function, and view objects should be made in the object specific file in the corresponding directory for the corresponding database, where possible.
   1. Scripts should be written to be resilient and survive **multiple executions** for the script.
      1. Add IF checks for existence.
      2. For consistent formatting for comparison purposes, the contents in these directories will be automatically generated by the Continuous Integration (CI) process and/or End of Sprint (EOS) and/or End of Release (EOR) processes.
   2. If needed, due to dependencies, changes to these objects can be made via the `_Changes` directory scripts.
   3. To DROP a previously defined object, include the DROP statement in the `_Changes` directory. Be sure to add an IF check to first verify that the object to be dropped exists.
6. **ALL** Database changes that cannot simply be modified in place should be made in the `_Changes` directory.
   1. Script filenames should follow naming conventions to facilitate keeping change scripts in **intended order** (e.g. `SP###_<seq##>_<story####>_<objectname>-{Table|Data}.sql`).
   2. Once the script has been MERGED into `main`, or parent release, branch thru PR approval, the script should **NOT** be changed any further.
      1. Once PR is approved, the script will be applied via automated CI process and should **NOT** be applied again.
      2. Any additional changes to the underlying object(s) and/or data should be done via ADDITIONAL compensating action script(s) in the `_Changes` directory.
      3. DB reviewers should **NOT** allow changes to scripts in `_Changes` directory once merged into `main`, or parent release, branch.
   3. Changes to table related objects such as indexes, constraints, and triggers should be done via scripts in `_Changes` directory.
   4. Changes to roles, users, user defined datatypes, database level triggers, and any other ancillary objects should be done via scripts in `_Changes` directory.
   5. Scripts should be written to be resilient and survive **multiple executions** for the script.
      1. Add IF checks for existence.
      2. DROP and CREATE, if no impact on referential integrity
   6. Scripts should be written to avoid **unintended** data loss.
      1. Add IF checks for existence.
      2. Prefer to use **ALTER** statements.
      3. Do **NOT** DROP and CREATE, if impact on referential integrity.
      4. Do **NOT** DELETE (or TRUNCATE) and INSERT, if impact on referential integrity.
   7. Scripts can include DML (i.e. insert, update, delete) to safely implement the intended change (e.g. adding a NOT NULL column).
   8. Scripts can include multiple objects to safely implement the intended change (e.g. foreign key constraint).
   9. For **DATA** scripts, scripts should only address **CLIENT AGNOSTIC** data, defined and originating from the product **ENGINEERING** team.
   10. DB change scripts (e.g. rules, configuration, reference data, etc.) that are not intended to be included in base product release packages should be put in a subfolder under `_Changes` directory.
       1. Internal
          1. Intended for use in internal product testing environments to complete functional testing (e.g. dummy test data)
       2. Client Abbreviation (e.g. OH, TX)
          1. Intended to capture scripts that will need to be run in specific client environments, not appropriate for ALL clients
   11. Scripts from `_Changes` directory should automatically generate corresponding changes to corresponding object directories as part of **Continuous Integration** automation.
